<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin • Free Drink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body{margin:0;padding:0;background:#0f0f12;color:#f4f4f7;font-family:system-ui,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:28px}
    .card{background:#17171c;border:1px solid #2a2a32;border-radius:16px;padding:22px;margin-bottom:18px}
    h1,h2{margin-top:0}
    label{display:block;margin-top:10px;margin-bottom:6px;opacity:.9}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a32;background:#111118;color:#fff}
    .btn{display:inline-block;border:none;background:#6ef3a5;color:#04140b;font-weight:700;padding:10px 14px;border-radius:12px;font-size:15px;cursor:pointer;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{border-bottom:1px solid #2a2a32;padding:8px 6px;text-align:left}
    th{background:#1c1c22;font-weight:600}
    tr:hover td{background:#1a1a1f}
    .muted{opacity:.7;font-size:13px}
    .qr{background:#fff;border-radius:10px;padding:6px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin • Free Drink Dashboard</h1>
      <p class="muted">Manage bars and view all customer sign-ups</p>
    </div>

    <div class="card">
      <h2>Add New Bar</h2>
      <label>Bar Code</label>
      <input id="barCode" placeholder="e.g. nav001">
      <label>Bar Name</label>
      <input id="barName" placeholder="e.g. Bar Navigli">
      <button id="addBar" class="btn">Add Bar</button>
      <div id="barMsg" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>Existing Bars</h2>
      <table id="barsTbl">
        <thead>
          <tr><th>Code</th><th>Name</th><th>Active</th><th>Created</th><th>Customer Link</th><th>QR</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Customer Sign-ups</h2>
      <table id="claimsTbl">
        <thead>
          <tr>
            <th>Bar</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>DOB</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const addBarBtn = document.getElementById('addBar');
    const msg = document.getElementById('barMsg');
    const barsBody = document.querySelector('#barsTbl tbody');
    const claimsBody = document.querySelector('#claimsTbl tbody');

    async function loadBars() {
      const res = await fetch('/api/bars');
      const bars = await res.json();
      barsBody.innerHTML = '';
      bars.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${b.code}</td>
          <td>${b.name}</td>
          <td>${b.active ? '✅' : '❌'}</td>
          <td>${new Date(b.created_at).toLocaleString()}</td>
          <td><a href="/b/${b.code}" target="_blank">/b/${b.code}</a></td>
          <td><img class="qr" width="60" src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://free-drink-qr.onrender.com/b/${b.code}"></td>
        `;
        barsBody.appendChild(tr);
      });
    }

    async function loadClaims() {
      const res = await fetch('/api/claims');
      const claims = await res.json();
      claimsBody.innerHTML = '';
      claims.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.bar}</td>
          <td>${c.name || '-'}</td>
          <td>${c.phone || '-'}</td>
          <td>${c.email || '-'}</td>
          <td>${c.dob ? new Date(c.dob).toLocaleDateString() : '-'}</td>
          <td>${c.status}</td>
          <td>${new Date(c.created_at).toLocaleString()}</td>
        `;
        claimsBody.appendChild(tr);
      });
    }

    addBarBtn.addEventListener('click', async () => {
      const code = document.getElementById('barCode').value.trim();
      const name = document.getElementById('barName').value.trim();
      if (!code || !name) { msg.textContent = 'Enter both code and name'; return; }
      msg.textContent = 'Adding...';
      const res = await fetch('/api/bars', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, name })
      });
      if (res.ok) {
        msg.textContent = '✅ Added successfully';
        loadBars();
      } else {
        const j = await res.json();
        msg.textContent = '❌ ' + (j.error || 'Error');
      }
    });

    loadBars();
    loadClaims();
  </script>
</body>
</html>
