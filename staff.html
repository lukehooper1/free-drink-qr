<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Staff • Redeem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body{margin:0;padding:0;background:#0f0f12;color:#f4f4f7;font-family:system-ui,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:28px}
    .card{background:#17171c;border:1px solid #2a2a32;border-radius:16px;padding:22px}
    h1{margin:0 0 12px;font-size:24px}
    .barTag{display:inline-block;background:#22232b;border:1px solid #2e2f39;padding:6px 10px;border-radius:8px;font-size:13px;margin-bottom:8px}
    label{display:block;margin-top:10px;margin-bottom:6px;opacity:.9}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a32;background:#111118;color:#fff}
    .btn{display:inline-block;border:none;background:#6ef3a5;color:#04140b;font-weight:700;padding:12px 14px;border-radius:12px;font-size:16px;cursor:pointer;margin-top:12px}
    .error{background:#2a1212;border:1px solid #6b1d1d;color:#ffdede;padding:10px;border-radius:10px;margin-top:10px}
    .ok{background:#122a1a;border:1px solid #1d6b36;color:#d5ffe6;padding:10px;border-radius:10px;margin-top:10px}
    #reader{width:100%;margin-top:12px}
  </style>
  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Staff • Redeem</h1>
      <div id="barTag" class="barTag"></div>

      <label>Scan customer QR</label>
      <div id="reader"></div>

      <label style="margin-top:14px;">Or paste code manually</label>
      <input id="nonce" placeholder="One-time code">
      <button id="redeemBtn" class="btn">Redeem</button>

      <div id="err" class="error" style="display:none;"></div>
      <div id="ok" class="ok" style="display:none;"></div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const staffBar = qs.get('bar');

    const barTag = document.getElementById('barTag');
    const nonceEl = document.getElementById('nonce');
    const err = document.getElementById('err');
    const ok = document.getElementById('ok');
    const btn = document.getElementById('redeemBtn');

    barTag.textContent = staffBar ? `Bar Code: ${staffBar}` : 'Missing ?bar= in URL';

    async function redeem(nonce) {
      err.style.display='none'; ok.style.display='none';
      btn.disabled = true;
      try {
        const r = await fetch('/api/redeem', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nonce, staffBar })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Redeem failed');
        ok.style.display='block';
        ok.textContent = 'Redeemed ✅';
      } catch(e) {
        err.style.display='block';
        err.textContent = String(e.message || 'Error');
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', () => {
      const n = nonceEl.value.trim();
      if (!n) { err.style.display='block'; err.textContent='Enter a code'; return; }
      redeem(n);
    });

    // Start QR scanner with back camera preference
    window.addEventListener('load', () => {
      if (!window.Html5Qrcode || !staffBar) return;
      const html5QrCode = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(cams => {
        if (!cams || cams.length === 0) return;

        // Prefer a back/rear camera, otherwise pick the last camera
        let camId = null;
        const backCam = cams.find(c => /back|rear|environment/i.test(c.label));
        camId = backCam ? backCam.id : cams[cams.length - 1].id;

        html5QrCode.start(
          camId,
          { fps: 10, qrbox: { width: 240, height: 240 } },
          (decodedText) => {
            const n = decodedText.trim();
            if (n) {
              nonceEl.value = n;
              html5QrCode.stop();
              redeem(n);
            }
          },
          (errMsg) => { /* ignore scan errors */ }
        );
      }).catch(() => {});
    });
  </script>
</body>
</html>
